---
import Layout from "../../layouts/Layout.astro";
import { actions } from "astro:actions";
import UserRatings from "@components/Tables/UserRatings";
import type { ViewerResponse } from "../../types/viewers";

const id = Astro.params.id;
const numberId = Number(id);
const auth = Astro.locals.auth();

const result = await Astro.callAction(
  actions.viewers.getViewerWithRatingsAndMovies,
  {
    viewerId: numberId,
    sort: "RATING_SCORE_DESC",
  }
);

const getViewerWithRatingsAndMovies = result.data as ViewerResponse;
const { data: viewerData } = getViewerWithRatingsAndMovies;
const viewer = viewerData?.data;
const ratings = viewer?.ratings;
const ratingsWithMovies = ratings || [];
const isViewer =
  auth && ratings?.[0]?.clerkId && auth.userId === ratings[0].clerkId;
---

<Layout title={`${viewer?.name}'s Profile`}>
  <div class="container mx-auto p-4">
    <div
      class="bg-gray-800 rounded-lg p-6 mb-8"
      style={`border-left: 4px solid ${viewer?.color || "#000000"}`}
    >
      <div class="flex items-center gap-6">
        {
          viewer?.avatar && (
            <img
              src={viewer.avatar}
              alt={`${viewer.name}'s avatar`}
              class="w-24 h-24 rounded-full"
            />
          )
        }
        <div>
          <h1 class="text-4xl font-bold text-white mb-2">
            {viewer?.name}
            {isViewer && <span class="text-gray-400">(you)</span>}
          </h1>
          <div class="text-gray-300 space-y-1">
            {
              viewer?.discordUsername && (
                <p class="text-sm">
                  <span class="text-gray-400">Discord:</span>{" "}
                  {viewer.discordUsername}
                </p>
              )
            }
            {
              viewer?.isAdmin ? (
                <span class="inline-block bg-red-500 text-white text-xs px-2 py-1 rounded">
                  Admin
                </span>
              ) : null
            }
          </div>
        </div>
      </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6">
      <h2 class="text-2xl font-bold text-white mb-4">Ratings History</h2>
      <UserRatings client:load data={ratingsWithMovies} viewerId={numberId} />
    </div>
  </div>
</Layout>
