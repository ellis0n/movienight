---
import Layout from "../../layouts/Layout.astro";
import { actions } from "astro:actions";
import UserRatings from "@components/Tables/UserRatings";
const id = Astro.params.id as string;
const auth = Astro.locals.auth();

const getViewer = await Astro.callAction(
  actions.viewers.getViewerWithRatingsAndMovies,
  {
    viewerId: id,
    sort: "RATING_SCORE_DESC",
  }
);
const { data: viewer, error } = getViewer;

if (!viewer || error) {
  return Astro.redirect("/404");
}

const { viewerId, name, clerkId, ratings, movies } = viewer || {
  viewerId: "",
  name: "Unknown Viewer",
  clerkId: "",
  ratings: [],
  movies: [],
};

const ratingsWithMovies = ratings
  .map((rating) => {
    const movie = movies.find((movie) => movie.id === rating.movieId);
    return {
      viewerId: viewer.viewerId,
      ...rating,
      movieTitle: movie ? movie.title : "Unknown Movie",
      movieId: movie ? movie.id : "",
      score: rating.score,
      date: movie ? movie.date : null,
    };
  })
  .sort((a, b) => (Number(b.score) ?? 0) - (Number(a.score) ?? 0));

const isViewer = auth && clerkId && auth.userId === clerkId;
---

<Layout title={name}>
  <div
    class="container mx-auto p-6 text-white bg-gray-900 rounded-lg shadow-lg"
  >
    <h1 class="text-4xl font-bold mb-4">
      {isViewer && <span class="text-green-500">👁️</span>}
      {name}
    </h1>

    <h2 class="text-2xl font-semibold mb-4">Ratings:</h2>
    <UserRatings
      client:only="react"
      data={ratingsWithMovies}
      viewerId={id}
      isEditable={isViewer}
    />
  </div>
</Layout>
