---
import { MoviesDB, RatingsDB, ViewersDB } from "astro:db";
import { db } from "astro:db";

const movies = await db.select().from(MoviesDB);
const ratings = await db.select().from(RatingsDB);
const viewers = await db.select().from(ViewersDB);

const movieList = movies.map((movie) => {
  const movieRatings = ratings.filter((rating) => rating.movieId === movie.id);
  const movieViewers = viewers.filter((viewer) =>
    movieRatings.some((rating) => rating.viewerId === viewer.id)
  );
  return {
    ...movie,
    viewers: movieViewers.length,
  };
});

const convertToStars = (average: number) => {
  const starRating = Math.round(average / 2);
  return "‚≠ê".repeat(starRating);
};
---

<div class="text-white">
  <h2 class="text-4xl font-bold text-center mb-4">The List</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full bg-gray-800">
      <thead>
        <tr>
          <th class="py-2 px-4 border-b border-gray-700 text-left">Title</th>
          <th class="py-2 px-4 border-b border-gray-700 text-left">Consensus</th
          >
          <th class="py-2 px-4 border-b border-gray-700 text-left">Watchers</th>
        </tr>
      </thead>
      <tbody>
        {
          movieList.map((movie) => (
            <tr class="hover:bg-gray-700 text-lg">
              <td class="py-2 px-4 border-b border-gray-600 hover:bg-gray-600 h-full">
                <a
                  href={`/movies/${movie.id}`}
                  class="block h-full w-full flex items-center"
                >
                  {movie.title}
                </a>
              </td>
              <td class="py-2 px-4 border-b border-gray-600 hover:bg-gray-600 h-full">
                <span class="block h-full w-full flex items-center">
                  {convertToStars(movie.average)}
                </span>
              </td>
              <td class="py-2 px-4 border-b border-gray-600 hover:bg-gray-600 h-full">
                <span class="block h-full w-full flex items-center">
                  {movie.viewers}
                </span>
              </td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </div>
</div>
